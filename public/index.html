<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Telemetry Rehab Monitoring</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f5f7fa;
    --white:#fff;
    --text:#2d2f34;
    --accent:#1976d2;
    --accent-light:#e3f2fd;
    --card:#ffffff;
    --border:#dadee4;
  }

  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
  }

  .sidebar{
    position:fixed;
    top:0;left:0;
    width:240px;
    height:100vh;
    background:white;
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
    padding-top:20px;
  }
  .logo{
    font-size:20px;
    font-weight:bold;
    text-align:center;
    margin-bottom:25px;
    color:var(--accent);
  }

  .sideItem{
    padding:14px 22px;
    display:flex;
    align-items:center;
    gap:12px;
    cursor:pointer;
    font-size:15px;
  }
  .sideItem:hover{background:var(--accent-light);}
  .activeTab{background:var(--accent);color:white;}

  .main{
    margin-left:240px;
    padding:25px;
    height:100vh;
    overflow-y:auto;
  }

  .tabPage{display:none;}
  .tabActive{display:block;}

  button{
    margin-top:10px;
    background:#1976d2;
    color:white;
    padding:10px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
  }
  button:hover{opacity:0.85;}
</style>
</head>

<body>

<!-- ================== LOGIN SCREEN ================== -->
<div id="loginScreen" style="
  position:fixed;top:0;left:0;
  width:100%;height:100%;
  background:#f5f7fa;
  display:flex;align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:white;
    padding:28px;
    width:320px;
    border-radius:10px;
    border:1px solid #dadee4;
    text-align:center;
  ">
    <h2 style="color:#1976d2;margin-bottom:10px;">Clinician Login</h2>
    <input id="loginUser" placeholder="Username"
      style="width:100%;padding:10px;margin-bottom:8px;border:1px solid #ccc;border-radius:6px;">
    <input id="loginPass" placeholder="Password" type="password"
      style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-bottom:8px;">
    <button onclick="doLogin()" style="width:100%;">Login</button>
    <div id="loginError" style="color:red;margin-top:8px;font-size:13px;"></div>
  </div>
</div>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <div class="logo">Rehab Dashboard</div>

  <div class="sideItem activeTab" onclick="showTab('overview')">
    <span class="material-icons">dashboard</span> Overview
  </div>
  <div class="sideItem" onclick="showTab('biomech')">
    <span class="material-icons">fitness_center</span> Biomechanics
  </div>
  <div class="sideItem" onclick="showTab('motion')">
    <span class="material-icons">view_in_ar</span> Motion
  </div>
  <div class="sideItem" onclick="showTab('patients')">
    <span class="material-icons">person</span> Patients
  </div>
  <div class="sideItem" onclick="showTab('history')">
    <span class="material-icons">table_chart</span> Records
  </div>
  <div class="sideItem" onclick="showTab('alerts')">
    <span class="material-icons">warning</span> Alerts
  </div>
  <div class="sideItem" onclick="showTab('report')">
    <span class="material-icons">email</span> Report
  </div>
</div>

<!-- ================= MAIN ================= -->
<div class="main">

<!-- OVERVIEW -->
<div id="overview" class="tabPage tabActive">
  <h2>Realtime Rehabilitation Monitoring</h2>
  <canvas id="combinedChart" style="height:260px"></canvas>
  <button onclick="sendDemo()">Send Demo Reading</button>
</div>

<!-- BIOMECH -->
<div id="biomech" class="tabPage">
  <h2>Biomechanics</h2>
  <canvas id="chart_forceL"></canvas>
  <canvas id="chart_forceR"></canvas>
  <canvas id="chart_flex"></canvas>
  <canvas id="chart_temp"></canvas>
</div>

<!-- MOTION -->
<div id="motion" class="tabPage">
  <h2>Motion Analysis (Hall Sensors)</h2>
  <canvas id="chart_hx"></canvas>
  <canvas id="chart_hy"></canvas>
  <canvas id="chart_hz"></canvas>
</div>

<!-- PATIENT -->
<div id="patients" class="tabPage">
  <h2>Patient Profile</h2>

  <div style="display:flex;gap:30px;margin-top:20px;">
    <div style="
      background:white;width:290px;border-radius:12px;
      padding:22px;text-align:center;border:1px solid var(--border);
    ">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
        style="width:110px;height:110px;border-radius:50%;border:3px solid var(--accent);">

      <div id="pName"
        style="font-size:20px;font-weight:600;margin-top:10px;">Patient XYZ</div>
      <div style="color:#666;font-size:13px;">
        Patient ID: <span id="pID">#001</span>
      </div>
    </div>

    <div style="
      flex:1;background:white;border-radius:12px;padding:22px;
      border:1px solid var(--border);
    ">
      <h3>Clinical Information</h3>
      <table>
        <tr><td>Age</td><td id="pAge">21</td></tr>
        <tr><td>Diagnosis</td><td>Wrist Tendon Injury</td></tr>
        <tr><td>Doctor</td><td>Dr. ABC</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- ALERTS -->
<div id="alerts" class="tabPage">
  <h2>Clinical Alerts</h2>
  <div id="alertList" style="
    display:flex;flex-direction:column;
    gap:10px;width:70%;max-height:70vh;overflow-y:auto;
  "></div>
</div>

<!-- RECORDS -->
<div id="history" class="tabPage">
  <h2>Sensor Records</h2>
  <table id="historyTable">
    <thead>
      <tr style="background:#1976d2;color:white;">
        <th>Time</th><th>Temp</th><th>GSR</th>
        <th>F-L</th><th>F-R</th><th>Flex</th><th>HX</th><th>HY</th><th>HZ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- REPORT -->
<div id="report" class="tabPage">
  <h2>Send Report to Doctor</h2>
  <button onclick="downloadCSV()">Download CSV</button>
  <br><br>
  <button onclick="window.print()">Print Dashboard</button>
  <br><br>
  <button onclick="emailDoctor()">Email Report</button>
</div>

</div>

<script>
/* === LOGIN DB === */
const USERS=[
  {name:"Aditi Shreya",pass:"1234",patientID:"#001",age:21},
  {name:"Nandini Mudgal",pass:"1234",patientID:"#002",age:21},
  {name:"Yash Saini",pass:"1234",patientID:"#003",age:21},
  {name:"Apoorv Yadav",pass:"1234",patientID:"#004",age:21},
  {name:"Ayush Sharma",pass:"1234",patientID:"#005",age:21},
  {name:"Sumit Vyas",pass:"1234",patientID:"#006",age:45},
];

/* LOGIN */
function doLogin(){
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value.trim();
  const f=USERS.find(x=>x.name===u && x.pass===p);

  if(!f){
    document.getElementById("loginError").innerText="Invalid credentials.";
    return;
  }

  document.getElementById("loginScreen").style.display="none";
  document.getElementById("pName").innerText=f.name;
  document.getElementById("pID").innerText=f.patientID;
  document.getElementById("pAge").innerText=f.age;
}

/* TAB */
function showTab(id){
  document.querySelectorAll(".sideItem").forEach(x=>x.classList.remove("activeTab"));
  document.querySelectorAll(".tabPage").forEach(x=>x.classList.remove("tabActive"));
  event.target.closest(".sideItem").classList.add("activeTab");
  document.getElementById(id).classList.add("tabActive");
}

/* GRAPH */
function lineChart(id,color){
  return new Chart(document.getElementById(id),{
    type:"line",
    data:{labels:[],datasets:[{borderColor:color,data:[],borderWidth:2}]},
    options:{animation:false,plugins:{legend:{display:false}}}
  });
}

const ch={
  combined: lineChart("combinedChart","#1976d2"),
  fL: lineChart("chart_forceL","#ff9800"),
  fR: lineChart("chart_forceR","#e53935"),
  flex: lineChart("chart_flex","#43a047"),
  temp: lineChart("chart_temp","#fb8c00"),
  hx: lineChart("chart_hx","#1e88e5"),
  hy: lineChart("chart_hy","#8e24aa"),
  hz: lineChart("chart_hz","#3949ab")
};

const historyTable=document.querySelector("#historyTable tbody");
const alertList=document.getElementById("alertList");

/* ADD point to chart */
function add(chart,val){
  const t=new Date().toLocaleTimeString();
  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(val);
  chart.update();
}

/* ====== DEMO SEND (uses YOUR backend) ====== */
async function sendDemo(){
  await fetch("https://telemetry-backend-a6sr.onrender.com/ingest",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      temp:36+Math.random()*3,
      gsr:Math.random()*800,
      force_left:Math.random()*40,
      force_right:Math.random()*40,
      flex:Math.random()*120,
      hall_x:Math.random()*4,
      hall_y:Math.random()*4,
      hall_z:Math.random()*4,
    })
  });
}

/* === ALERT === */
function addAlert(title,message){
  const clean=message.replace(/[\u{1F300}-\u{1FAFF}]/gu,"");
  alertList.insertAdjacentHTML("afterbegin",`
    <div style="padding:10px;border:1px solid #ddd;border-left:4px solid red;border-radius:6px;">
      <div style="font-size:11px;color:#666;">${new Date().toLocaleTimeString()}</div>
      <div style="font-size:15px;font-weight:600;">${title}</div>
      <div style="font-size:13px;">${clean}</div>
    </div>
  `);
}

/* ===== POLLING ===== */
setInterval(async()=>{
  try{
    const r=await (await fetch("https://telemetry-backend-a6sr.onrender.com/latest")).json();
    if(!r.ts) return;

    add(ch.combined,r.temp);
    add(ch.fL,r.force_left);
    add(ch.fR,r.force_right);
    add(ch.flex,r.flex);
    add(ch.temp,r.temp);
    add(ch.hx,r.hall_x);
    add(ch.hy,r.hall_y);
    add(ch.hz,r.hall_z);

    historyTable.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${new Date(r.ts).toLocaleTimeString()}</td>
        <td>${r.temp}</td>
        <td>${r.gsr}</td>
        <td>${r.force_left}</td>
        <td>${r.force_right}</td>
        <td>${r.flex}</td>
        <td>${r.hall_x}</td>
        <td>${r.hall_y}</td>
        <td>${r.hall_z}</td>
      </tr>
    `);

    if(r.alerts){ r.alerts.forEach(a=>addAlert("Sensor Alert",a)); }

  }catch(e){}
},1500);

/* ===== CSV ===== */
function downloadCSV(){
  const rows=[["Time","Temp","GSR","Force L","Force R","Flex","HX","HY","HZ"]];
  document.querySelectorAll("#historyTable tbody tr").forEach(tr=>{
    rows.push([...tr.children].map(td=>td.innerText));
  });
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="rehab_data.csv";
  a.click();
}

/* ===== EMAIL ===== */
function emailDoctor(){
  window.location.href=`mailto:?subject=Telemetry Report&body=Attached rehab CSV`;
}
</script>
</body>
</html>